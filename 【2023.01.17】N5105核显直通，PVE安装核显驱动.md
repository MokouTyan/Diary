【2023.01.17】N5105核显直通给LXC，PVE安装核显驱动

先使用命令查看核显、渲染器权限及组

```
ls -l /dev/dri
```

![image-20230117133722787](https://i0.hdslb.com/bfs/album/a3ee877b36bf1fc991962d7969bd335418d8f16a.png)

更新内核

```
apt update && apt install pve-kernel-5.19
```

检查固件是否齐全

```
cd /lib/firmware/i915 && ls ehl_guc*.bin &&  ls ehl_huc*.bin &&  ls icl_dmc*.bin
```

![image-20230117134129664](https://i0.hdslb.com/bfs/album/6a9614f06939aaedcce8d1c8be549a0cbbad4df1.png)

### LXC准备

进入local下载CT模板中的Debian11，如果过慢的话，需要换源



![image-20230118100454310](https://i0.hdslb.com/bfs/album/b2773c4c7aa6a2b6d9fe5081ea9d76d13512b593.png)

![image-20230118100843418](https://i0.hdslb.com/bfs/album/26eb282161e97de93bfe460a7b380f246b4da9d9.png)

![image-20230118100927442](https://i0.hdslb.com/bfs/album/2d1a2dfef4241fd9abbd4cd8081ee0e75af24210.png)

磁盘分个10g就好，因为后面要用到群晖的SMB，具体看https://www.cnblogs.com/mokou/p/17042705.html

![image-20230118101110984](https://i0.hdslb.com/bfs/album/a72a08e6ef6a1be44efbe63b14a390e5f36b08c2.png)

![image-20230118101143730](https://i0.hdslb.com/bfs/album/20d9688cc6d80464530ab05f2c13a0f6761c6c49.png)

![image-20230118101204025](https://i0.hdslb.com/bfs/album/a1b0655d60af0ccc62c91eb4be932c97bd06c6ed.png)

![image-20230118101334025](https://i0.hdslb.com/bfs/album/5bda4d8cfb927975f8dbc17d9577fd4b744aa257.png)

DNS默认就行，创建完成

### 核显直通

在PVE内

```
ls -l /dev/dri
```

![image-20230118101857650](https://i0.hdslb.com/bfs/album/61149db3dabd0d1acf87c5a376003deec3e51046.png)

修改LXC配置，自己改下101对应虚拟机

得到的结果

```
drwxr-xr-x 2 root root         80 Jan 17 14:37 by-path
crw-rw---- 1 root video  226,   0 Jan 17 14:37 card0
crw-rw---- 1 root render 226, 128 Jan 17 14:37 renderD128
```

然后

```
nano /etc/pve/lxc/101.conf
```

加入

```
lxc.cgroup2.devices.allow: c 226:0 rwm
lxc.cgroup2.devices.allow: c 226:128 rwm
lxc.cgroup2.devices.allow: c 29:0 rwm
lxc.mount.entry: /dev/dri dev/dri none bind,optional,create=dir
lxc.apparmor.profile: unconfined
```

保存退出

修改配置

```
nano /etc/modprobe.d/i915.conf
```

加入

```
options i915 enable_guc=3
```

然后重启，检查

```
journalctl -b -o short-monotonic -k | egrep -i "i915|dmr|dmc|guc|huc"
```

查看是否存在GUC、HUC

![image-20230118104705779](https://i0.hdslb.com/bfs/album/c441e6b482445d0c8f6e42faa59942f4224ab5b5.png)

### 修改LXC配置

![image-20230118105005949](https://i0.hdslb.com/bfs/album/e02493f967540748dc3901980a590890fd9dc53a.png)

启动LXC的Debian，开启Debian远程root账号第三方SSH登录工具

```
nano /etc/ssh/sshd_config
修改下列
PermitRootLogin yes
PasswordAuthentication yes
重启lxc
```

就可以使用putty登陆了

![image-20230118105959527](https://i0.hdslb.com/bfs/album/2943a677b67632900d1f1fd159c2a1852cc9b8ee.png)

修改源，请见[【2022.11.19】服务器常用命令 - Mokou - 博客园 (cnblogs.com)](https://www.cnblogs.com/mokou/p/16909309.html)

### 挂载SMB

在LXC内

```
apt-get install cifs-utils
apt install samba
apt install samba-client
mkdir /mnt/share
```

尝试登陆

```
smbclient -L NAS的IP/或者群晖的名字 -U 用户名
```

挂载命令

```
mount -o username=账号,password=密码 //192.168.1.222/Video /mnt/share
```

具体见[Linux系统挂载SMB文件系统 (aliyun.com)](https://help.aliyun.com/document_detail/128737.html)

然后打开目录就可以看见文件

![image-20230118141526014](https://i0.hdslb.com/bfs/album/32d9fd6507566849afc35ee8094d6cd194b59f96.png)

也可以使用df -h的命令进行检查

然后设置为开机自动挂载

```
nano /etc/fstab
```

加入

```
//192.168.1.222/Video /mnt/share cifs defaults,username=账号,password=密码
```

然后reboot后用df -h查看

![image-20230118142815843](https://i0.hdslb.com/bfs/album/4cf30b10f5d23cf0d94dcc914af656e9301ea422.png)

挂载成功

### 安装Jellyfin

安装docker

```
apt install curl -y
curl -sSL https://get.docker.com/ | sh
```

安装portainer

```
docker run -d -p 9000:9000 \
    --restart=always \
    -v /var/run/docker.sock:/var/run/docker.sock \
    --name prtainer \
    portainer/portainer
```

进入portainer，安装N大的jellyfin

nyanmisaka/jellyfin:latest

![image-20230118144352843](https://i0.hdslb.com/bfs/album/277973f3c1f9f94e4ad79d4de1b163a1ef4ed34b.png)

![image-20230118144439632](https://i0.hdslb.com/bfs/album/e67ab74e086c530a01fe7eb69cf9d5f7c2b97554.png)

![image-20230118144619580](https://i0.hdslb.com/bfs/album/2837134d8db92a4bbc31f1780da1373a0925ca0b.png)

添加驱动/dev/dri

![image-20230118144724481](https://i0.hdslb.com/bfs/album/a6f3d9abcc437ce5e32e622f319d59e02cfc0f61.png)

然后部署

![image-20230118144752398](https://i0.hdslb.com/bfs/album/bcec22df98f371ddce396466346561383b26c703.png)

等待一段时间

### 配置jellyfin

![image-20230118150341153](https://i0.hdslb.com/bfs/album/eedca1cf90534082ec5fff94a14b5f666c28861d.png)

![image-20230118150409166](https://i0.hdslb.com/bfs/album/c411bea39e588a4c322d51da39455a65c0f4a7ef.png)

![image-20230118150720350](https://i0.hdslb.com/bfs/album/e54f83623c7451822f006fc57592a1615ff43422.png)

选择目录，可以看到我们的SMB

![image-20230118150507754](https://i0.hdslb.com/bfs/album/ff2bacfcd849ec0aee7567546fd686f68923c95e.png)

![image-20230118150649988](https://i0.hdslb.com/bfs/album/6ba03ca55b1e0f52af1e6f2c22945b2459402ffe.png)

![image-20230118150818017](https://i0.hdslb.com/bfs/album/70c49cb7ef5f105f368174f2f8b8a2db903ea2af.png)

![image-20230118151726610](https://i0.hdslb.com/bfs/album/a0426f0a73e77579aa4b0c3c9bfc6a32ba591edf.png)

![image-20230118151757747](https://i0.hdslb.com/bfs/album/c0f913eba4ccebf7aa422731ca4fff2c8576778f.png)

拉到最下面，保存

### 脚本

在LXC机器内

```
cat>>/etc/systemd/system/rc-local.service<<EOF
```

输入，然后回车

```
[Unit]
Description=/etc/rc.local
ConditionPathExists=/etc/rc.local
[Service]
Type=forking
ExecStart=/etc/rc.local start
TimeoutSec=0
StandardOutput=tty

RemainAfterExit=yes
SysVStartPriority=99
[Install]
WantedBy=multi-user.target
EOF
```

输入开机运行

```
systemctl enable rc-local.service
```

输入

```
cat <<EOF >/etc/rc.local
```

输入并回车

```
#!/bin/sh -e
#
# rc.local
#
# This script is executed at the end of each multiuser runlevel.
# Make sure that the script will "exit 0" on success or any other
# value on error.
#
# In order to enable or disable this script just change the execution
# bits.
#
# By default this script does nothing.
chmod 777 /dev/dri/*
sleep 30
systemctl restart docker
exit 0
EOF
```

赋权

```
chmod +x /etc/rc.local
```

然后reboot后

查看权限

```
ls -l /dev/dri
```

![image-20230118152535137](https://i0.hdslb.com/bfs/album/b3f4a5fc40893f96388ba2d0d496df9145e53a7b.png)

全部显示，说明成功了

### 安装GPU监控

```
apt-get update && apt install intel-gpu-tools -y
```

当开始运行转码的时候，在LXC输入该命令查看GPU占用

```
intel-gpu-tools
```

### 参考链接

[【更新】免费开源影音服务Jellyfin部署，PVE下LXC套娃安装Debian Docker，核显硬解转码以N5105为例低功耗intel CPU核显通用_哔哩哔哩_bilibili](https://www.bilibili.com/video/BV1Xx4y1G7MG/?buvid=XX5D0155C1CB2EC21D771E676630B2AF9B19E&is_story_h5=false&mid=BxrSe5%2Bzv5ZfgxfNA2RWuw%3D%3D&p=1&share_from=ugc&share_medium=android&share_plat=android&share_session_id=2b8af447-0026-4330-826f-6255fccaa21c&share_source=QQ&share_tag=s_i&timestamp=1673885298&unique_k=yY2Sxvs&up_id=455976991&vd_source=d3b20de6fd728a6822df14fa2e26ef8c)

[Linux系统挂载SMB文件系统 (aliyun.com)](https://help.aliyun.com/document_detail/128737.html)

[linux smb 自动挂载,linux 下 用mount 挂载 samba 以及Linux 开机自动挂载 samba_weixin_39856709的博客-CSDN博客](https://blog.csdn.net/weixin_39856709/article/details/116768056)

[Linux挂载群晖SMB共享目录教程---以centos举例 - Synology群晖 - NAS网络存储论坛 - Powered by Discuz! (zzdynas.com)](https://www.zzdynas.com/forum.php?mod=viewthread&tid=184)