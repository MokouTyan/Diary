【2023.01.19】openwrt里开启双adguard home，搭配openclash对应海内外不同解析

使用的是恩山论坛的高大全版本，带docker环境了

[【2023-1-10】Openwrt x86更新最新5.15内核5.15.86 高大全插件+应用商店-OPENWRT专版-恩山无线论坛 (right.com.cn)](https://www.right.com.cn/forum/forum.php?mod=viewthread&tid=8248898&extra=page%3D1&page=1)

教程来源于[N1 X86 openwrt双AdGuardHome 配置对接SSRP PassWall以及DNS分流教程 | 晓峰部落阁 (wxf2088.xyz)](https://wxf2088.xyz/3027.html)

先暂时给个DNS

![image-20230119084931613](https://i0.hdslb.com/bfs/album/6780965cb3e523924d95e5b103696d8b35d32cbb.png)

### 下载脚本

```
#创建路径
mkdir -p /mnt/mmcblk2p4/adg
#执行一键安装脚本
wget https://raw.githubusercontent.com/wxfyes/adg/main/adg.sh && sh adg.sh
```

如果是刚开始的话可以按照这个数字顺序创建

```
211021退出验证一下311去第一个容器先进行修改
```

![image-20230119094344616](https://i0.hdslb.com/bfs/album/5ec10f97b406000612d1844455c92cbb43f59d05.png)

在DNS设置里填入

```
##上游DNS
tls://dns.pub
tls://dns.alidns.com
https://doh.pub/dns-query
https://dns.pub/dns-query
https://dns.alidns.com/dns-query
##国内Bootstrap DNS
114.114.114.114
```

选择并行请求

![image-20230119094627504](https://i0.hdslb.com/bfs/album/d052c642c6343891cca1515ae716c2e962e41a8e.png)

速度限制改为0

![image-20230119094703984](https://i0.hdslb.com/bfs/album/3d513db443a9d4c98be18aa9b33160120e1e4d81.png)

回到脚本创建第二个海外DNS解析

![image-20230119094921082](https://i0.hdslb.com/bfs/album/a6b09a4864a4e8122aee13193d1bbff1b9dc9e52.png)

然后进入DNS设置

```
#上游DNS服务
tls://1.1.1.1/dns-query
tls://dns.google 
https://dns.google/dns-query 
tls://dns11.quad9.net
https://dns11.quad9.net/dns-query
#国外Bootstrap DNS
9.9.9.10
8.8.8.8
##如果只用tcp/udp协议的DNS，bootstarpDNS可以不填，留空就行
DOH/DOT必须填写地址
```

### OpenClash配置

![image-20230119095842004](https://i0.hdslb.com/bfs/album/41674dd9a7f843ed82d724b03963575443a432bf.png)

保存配置

![image-20230119100000898](https://i0.hdslb.com/bfs/album/be01dbddb12ef8b833cbe8258a721fe8166565d8.png)

自定义 Fallback-Filter里面全部删掉，修改为https://raw.githubusercontent.com/wxfyes/cf/main/openclashfallback.txt的内容

保存配置

将自定义上游全部取消

![image-20230119100258959](https://i0.hdslb.com/bfs/album/b0dd6ffaee4ea381e05acc5fff6d0f6b4b9131fe.png)

新增两个

一个是Nameserver对应国内5301端口

![image-20230119100344686](https://i0.hdslb.com/bfs/album/ca619b713f657e15ce668960d6663dc3b6f058ba.png)

海外选择Fallback，对应5302端口，选择TCP（图上没改

![image-20230119100430748](https://i0.hdslb.com/bfs/album/aab5bcaecb2e67123ace7f5d8ce62c42d14a67d8.png)

最后结果

![image-20230119100523094](https://i0.hdslb.com/bfs/album/6105c815909548a55f9ef083b6e89902b8c6e75d.png)

GEOIP配置

![image-20230119100619798](https://i0.hdslb.com/bfs/album/6de5931369018d0e0109f6dd29b695c723c0eda6.png)