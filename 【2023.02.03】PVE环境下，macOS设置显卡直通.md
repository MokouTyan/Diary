【2023.02.03】PVE环境下，macOS设置显卡直通

### 前期准备

需要在不直通的情况下进入macOS过

需要开启IOMMU VT-d

用脚本进行测试

```
bash -c "$(curl -fsSL https://gist.githubusercontent.com/ShadowySpirits/018ea8675100baf768afff0d835e7862/raw/8e1c12f5766f0d308628ad1373b2f8603c523480/check_iommu.sh)"
```

如果连不上那就自己nano一个测试

```
#!/bin/bash
shopt -s nullglob
for g in $(find /sys/kernel/iommu_groups/* -maxdepth 0 -type d | sort -V); do
    echo "IOMMU Group ${g##*/}:"
    for d in $g/devices/*; do
        echo -e "\t$(lspci -nns ${d##*/})"
    done;
done;
```

可以看到以下信息，也可以看到核显和独显

```
IOMMU Group 2:
        00:02.0 VGA compatible controller [0300]: Intel Corporation CoffeeLake-H GT2 [UHD Graphics 630] [8086:3e9b] (rev 02)
        
IOMMU Group 16:
        01:00.0 3D controller [0302]: NVIDIA Corporation GP102GL [Tesla P40] [10de:1b38] (rev a1)
```

记下8086:3e9b与10de:1b38

![image-20230203090259370](https://i0.hdslb.com/bfs/new_dyn/9eb0ad496bb10be292c4d2e32198a9781865692.png)

```
nano /etc/modules
```

中加入

```
vfio
vfio_iommu_type1
vfio_pci
vfio_virqfd
```

然后重启

```
nano /etc/modprobe.d/vfio.conf
```

从上面的句子中可以得到要输入的内容，将显卡的供应商-设备 ID 传递给 vfio 驱动

```
options vfio-pci ids=8086:3e9b,8086:a348,10de:1b38 disable_vga=1
```

![image-20230203091212676](https://i0.hdslb.com/bfs/new_dyn/56fba2f9f192425a7969cbd0f6151e3f1865692.png)

禁用其他显卡驱动

```
nano /etc/modprobe.d/blacklist.conf
```

加入

```
# NVIDIA
blacklist nvidiafb
blacklist nouveau
blacklist nvidia
blacklist snd_hda_intel

# Intel
blacklist snd_hda_codec_hdmi
blacklist i915

# AMD
blacklist radeon

```

然后更新配置

```
update-initramfs -u
```

重启

使用命令查看VFIO模块是否加载

```bash
lsmod | grep vfio
```

以下为已开启

![image-20230203103627102](https://i0.hdslb.com/bfs/new_dyn/30677728633b9f18951d56638ecee30f1865692.png)

### 核显直通

只需要勾选所有功能

![image-20230203103742307](https://i0.hdslb.com/bfs/new_dyn/645434d6d1f3c3acbc7a25a8b1ca7fbc1865692.png)

### 下载Opencore编辑器和Hackintool

在mac系统里下载oc编辑器

[Download OpenCore Configurator 2.66.1.0 | mackie100 projects](https://mackie100projects.altervista.org/download-opencore-configurator/)

还有Hackintool

[benbaker76/Hackintool: The Swiss army knife of vanilla Hackintoshing (github.com)](https://github.com/benbaker76/Hackintool)

如果打不开的话在系统设置的安全隐私里面仍然运行

![image-20230203103151072](https://i0.hdslb.com/bfs/new_dyn/b556e4dc999c4cc204f3093d8b2163091865692.png)

![image-20230203103206991](https://i0.hdslb.com/bfs/new_dyn/6ddef387e2d13ef7120145c7e01af1721865692.png)

![image-20230203103247184](https://i0.hdslb.com/bfs/new_dyn/d7139a07d1ead030740cacbc5320335e1865692.png)

### 生成三码

因为当前机型对核显无优化，因此要改变机型

![image-20230203154043259](https://i0.hdslb.com/bfs/new_dyn/a8b83bdb7260b45ac9072fa65dbd6bc31865692.png)

因为我的机器为nuc9，原生CPU，所以选择9980hk

![image-20230203154303165](https://i0.hdslb.com/bfs/new_dyn/f3b4da7b36a9482d496810a62276591d1865692.png)

然后生成

![image-20230203154421456](https://i0.hdslb.com/bfs/new_dyn/560487e554b7dfeb818033e307ebf5801865692.png)

下面那个框一般用不上

![image-20230203154626999](https://i0.hdslb.com/bfs/new_dyn/9fe334cb93e3171d2ab430bd02f080b91865692.png)

### 核显

在Hackintool里面找到，右键选第二个，拷贝设备路径

![image-20230203155641959](https://i0.hdslb.com/bfs/new_dyn/1dd3bd5bdec61f3d020c826dedfc8c911865692.png)

### 虚拟机配置修改

```
nano /etc/pve/nodes/pve/qemu-server/105.conf
```

修改

```
# args在后面加入就行
args: -set device.hostpci0.x-igd-gms=1
cpu: host
hostpci0: 0000:00:02.0,legacy-igd=1
vga: none
```



### 参考链接

[PVE 虚拟化黑苹果显卡直通及远程访问教程 (lv5.moe)](https://blog.lv5.moe/p/pve-virtualized-hackintosh-gpu-passthrough-and-remote-access-tutorial)

[国光的 PVE 生产环境配置优化记录 | 国光 (sqlsec.com)](https://www.sqlsec.com/2022/04/pve.html#添加-VFIO-模块)