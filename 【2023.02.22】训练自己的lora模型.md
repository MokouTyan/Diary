【2023.02.22】训练自己的lora模型

### 前言

本文仅是自娱自乐，用来生成自己在世界各地的旅游图

### 下载

[bmaltais/kohya_ss (github.com)](https://github.com/bmaltais/kohya_ss)

根据内容先下载好python，git，Visual Studio

以管理员身份启动PowerShell

```
Set-ExecutionPolicy Unrestricted
```

输入A

在目录中开始下载并配置，最好一句句来

CP用不了的话，手动拷贝一下

```
git clone https://github.com/bmaltais/kohya_ss.git
cd kohya_ss

python -m venv venv
.\venv\Scripts\activate

pip install torch==1.12.1+cu116 torchvision==0.13.1+cu116 --extra-index-url https://download.pytorch.org/whl/cu116
pip install --use-pep517 --upgrade -r requirements.txt
pip install -U -I --no-deps https://github.com/C43H66N12O12S2/stable-diffusion-webui/releases/download/f/xformers-0.0.14.dev0-cp310-cp310-win_amd64.whl

cp .\bitsandbytes_windows\*.dll .\venv\Lib\site-packages\bitsandbytes\
cp .\bitsandbytes_windows\cextension.py .\venv\Lib\site-packages\bitsandbytes\cextension.py
cp .\bitsandbytes_windows\main.py .\venv\Lib\site-packages\bitsandbytes\cuda_setup\main.py

accelerate config
```

然后开始配置，这里是0123456进行切换，回车选择

第一个This Machine

第二个No distributed training

第三个选NO，因为我有GPU

第四个NO

第五个NO

第六个ALL，一般也不会有交火吧

第七个NO

配置结束

因为我是P40 CUDNN用不了，所以不选可选选项，30，40系可以做下面加速

### 运行

在目录下运行upgrade.ps1

双击GUI.bat

进入lora界面

![](https://img2023.cnblogs.com/blog/1446116/202302/1446116-20230222012946794-1452359679.png)

### 打标

找个位置新建三个文件夹，对应不同功能，准备一些图片

![](https://img2023.cnblogs.com/blog/1446116/202302/1446116-20230222013622448-2087106975.png)

然后在image里面建一个文件夹100，说明模型看100次，我放入了26张照片

然后进入这个页面，输入你的称呼

![](https://img2023.cnblogs.com/blog/1446116/202302/1446116-20230222021049069-233592820.png)

运行一会，你就可以点开txt查看这个标签是否正确，有错误稍微修改

![](https://img2023.cnblogs.com/blog/1446116/202302/1446116-20230222021430013-68367872.png)

### 运行

选择Dreambooth LoRA标签页，可以像我这样配置

![](https://img2023.cnblogs.com/blog/1446116/202302/1446116-20230222013422793-675190379.png)

然后选择图片文件夹注意不要选到下一级

![](https://img2023.cnblogs.com/blog/1446116/202302/1446116-20230222021915752-918805784.png)

这里看你显存大小，我选了个4张并行

![](https://img2023.cnblogs.com/blog/1446116/202302/1446116-20230222022210007-1644015508.png)

然后开始Train model

如果无法成功的话，可以先取消勾选Use 8bit adam再试一次

完成后在文件夹可以找到

![](https://img2023.cnblogs.com/blog/1446116/202302/1446116-20230222215238730-1017418850.png)

放入lora文件夹调用，效果还是非常不错的

![](https://img2023.cnblogs.com/blog/1446116/202302/1446116-20230223014154829-1377667702.png)