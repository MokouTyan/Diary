【2022.11.21】PVE创建基于LXC的Docker容器

### CT模板换源

```
cp /usr/share/perl5/PVE/APLInfo.pm /usr/share/perl5/PVE/APLInfo.pm_back
sed -i 's|http://download.proxmox.com|https://mirrors.tuna.tsinghua.edu.cn/proxmox|g' /usr/share/perl5/PVE/APLInfo.pm
```

重启服务

```
systemctl restart pvedaemon.service
```

### 下载模板

选择要下载的存储空间进行下载，我下载的是debian

![image-20221121110515791](https://i0.hdslb.com/bfs/album/0077564b9ec55ce9c7abfc76451a17eba174fe65.png)



### 创建CT

我需要建一个不需要太多数据的虚拟机，因此起名为nodata

![image-20221121131740952](https://i0.hdslb.com/bfs/album/b65a7e5d88fbf75f309cfce99efb25b92afd0dd8.png)

![image-20221121131832251](https://i0.hdslb.com/bfs/album/fdf83aa59984b20c69e9d73d17139fc8d8741e55.png)

![image-20221121132003856](https://i0.hdslb.com/bfs/album/33bbf8cd80d174e819320aef7ff529aef272144e.png)

![image-20221121132835369](https://i0.hdslb.com/bfs/album/c1baef3871d967f8d5dedc9dba2924dfe2628eb2.png)

这里的内存是弹性的，设置只是一个上限

![image-20221121132910079](https://i0.hdslb.com/bfs/album/170287a5dcb01b22d3b36778938f9e76102eea5e.png)

![image-20221121132943324](https://i0.hdslb.com/bfs/album/44738bb6b162a561f18641a0dc99585a0199b061.png)

![image-20221121133338542](https://i0.hdslb.com/bfs/album/4f4679332e55feb3f502fd2d0f3a2beb8ff024fe.png)

### 硬件设置

查询硬件参数

```
ls -l /dev/dri
```

得到以下的参数

```
drwxr-xr-x 2 root root         80 Nov 18 22:31 by-path
crw-rw---- 1 root video  226,   0 Nov 18 22:31 card0 #这个是显卡
crw-rw---- 1 root render 226, 128 Nov 18 22:31 renderD128 # 这个是渲染机
```

根据容器的ID，输入命令

```
nano /etc/pve/lxc/[CT_ID].conf
```

比如我的[CT_ID]是101，就要改为101.conf

再后方黏贴，保存退出

```
lxc.cgroup2.devices.allow: c 226:0 rwm
lxc.cgroup2.devices.allow: c 226:128 rwm
lxc.cgroup2.devices.allow: c 29:0 rwm
lxc.mount.entry: /dev/dri dev/dri none bind,optional,create=dir
lxc.mount.entry: /dev/fb0 dev/fb0 none bind,optional,create=file
lxc.apparmor.profile: unconfined
```

切换到debian的命令行，而不是PVE的命令行

换debian源

```
mv /etc/apt/sources.list /etc/apt/sources.list.bk
nano /etc/apt/sources.list
```

输入

```
deb https://mirrors.ustc.edu.cn/debian/ bullseye main non-free contrib
deb-src https://mirrors.ustc.edu.cn/debian/ bullseye main non-free contrib
deb https://mirrors.ustc.edu.cn/debian-security/ bullseye-security main
deb-src https://mirrors.ustc.edu.cn/debian-security/ bullseye-security main
deb https://mirrors.ustc.edu.cn/debian/ bullseye-updates main non-free contrib
deb-src https://mirrors.ustc.edu.cn/debian/ bullseye-updates main non-free contrib
deb https://mirrors.ustc.edu.cn/debian/ bullseye-backports main non-free contrib
deb-src https://mirrors.ustc.edu.cn/debian/ bullseye-backports main non-free contrib
```

### 安装docker

查看[【2022.11.19】服务器常用命令 - Mokou - 博客园 (cnblogs.com)](https://www.cnblogs.com/mokou/p/16909309.html)