【2023.01.19】PVE部署openwrt，并转换磁盘

将iso文件上传到PVE里头后创建虚拟机

![image-20230119082315230](https://i0.hdslb.com/bfs/album/77be4b33926ef1bd7ef6c0f28fcaf75f63941e85.png)

![image-20230119082332588](https://i0.hdslb.com/bfs/album/fa13d57d11c48426fd08805b79f1910e406e78db.png)

![image-20230119082413809](https://i0.hdslb.com/bfs/album/7717fb8d0637221e7328e65e681ec89b1d7f5102.png)

![image-20230119083355443](https://i0.hdslb.com/bfs/album/ad494be89344fc73b1c8ea4c0bae171d2de99235.png)

![image-20230119083406983](https://i0.hdslb.com/bfs/album/b5b87a0e8af93193ae919f05195367bf7a76a8e1.png)

![image-20230119083445044](https://i0.hdslb.com/bfs/album/16331f401175cd8a16a1d869f1ac3e5afb9ad062.png)

![image-20230119083518260](https://i0.hdslb.com/bfs/album/bc168ccc71e14eacf74ce347e2a000664df22540.png)

![image-20230119083541180](https://i0.hdslb.com/bfs/album/9f62e2815c4b0240e6c25469d6e3e3c90ef10505.png)

在PVE的shell里面

```
qm importdisk 103 /var/lib/vz/template/iso/openwrt5.15.img local-lvm
```

103是虚拟机号，后面是上传路径和存储位置

得到结果

Successfully imported disk as 'unused0:local-lvm:vm-103-disk-0'

添加磁盘

![image-20230119084048037](https://i0.hdslb.com/bfs/album/a8b8594658771ede4f04187bd3016c555fbdc6ef.png)

更换引导顺序

扩容磁盘

![image-20230119092325256](https://i0.hdslb.com/bfs/album/cf1386759a702a1b6a149b7beaae5383518cf66f.png)

然后开机

```
opkg update
opkg install cfdisk fdisk e2fsprogs
```

使用cfdisk进行扩容

![image-20230119092923255](https://i0.hdslb.com/bfs/album/506361815c2ab5ef04eeb0844ea8b289186009d6.png)

![image-20230119092958452](https://i0.hdslb.com/bfs/album/f3f58df1dfd52848379432ee202a6da7ae4c7cd3.png)

![image-20230119093023826](https://i0.hdslb.com/bfs/album/0f4c17be40d1160a4951b35ecd55e84d79afb3a1.png)

输入 **yes** 按下回车键，确认写入新分区。

切换 **Quit** ，按下回车键退出。运行 `fdisk -l` 命令，查看是否成功创建新分区。

然后格式化分区

```
mkfs.ext4 /dev/sda3
```

### 挂载新分区

进入 Open­Wrt 管理后台，依次点击 **系统** - **挂载点** 找到并点击全局设置中的 **生成配置** 。然后刷新

![image-20230119093234403](https://i0.hdslb.com/bfs/album/1c31ceb7cebd5cc2e57f232a0f083c11d27f6cb1.png)

点击修改

![image-20230119093321030](https://i0.hdslb.com/bfs/album/7d0e8130a6d6eb38b6dcc92030d14ecbb2487850.png)

选择根，然后复制下面命令，并应用保存

![image-20230119093409892](https://i0.hdslb.com/bfs/album/1192421dace0f4233933a5ce40acb4c0f8e7d77e.png)

修改命令

![image-20230119093602351](https://i0.hdslb.com/bfs/album/cc0939b1fd1a274d93ea30714da267107d7ada3f.png)

```

mkdir -p /tmp/introot
mkdir -p /tmp/extroot
mount --bind / /tmp/introot
mount /dev/sda3 /tmp/extroot
tar -C /tmp/introot -cvf - . | tar -C /tmp/extroot -xf -
umount /tmp/introot
umount /tmp/extroot
```

进入SSH一句一句运行，结束后reboot

### 参考链接

[OpenWrt 存储空间扩容的两种方案 - OpenWrt开发者之家](https://www.openwrt.pro/post-594.html)